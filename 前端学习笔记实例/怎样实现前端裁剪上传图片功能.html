<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>怎样实现前端裁剪上传图片功能</title>
    <script type="text/javascript" src="../js/jquery.js"></script>
</head>

<body>
    <script type="text/javascript">
    var handler = {
        init: function($container) {
            //需要把dragover的默认行为禁掉，不然会跳页
            /*$container.on("dragover", function(event){
                event.preventDefault();
            });
             $container.on("drop", function(event){
                event.preventDefault();
                //这里获取拖过来的图片文件，为一个File对象
                var file = event.originalEvent.dataTransfer.files[0];  //第10行
                handler.handleDrop($(this), file);     //第11行
            }); */
            //如果使用input，则监听input的change事件：
            $container.on("change", "input[type=file]", function(event) {
                if (!this.value) return;
                var file = this.files[0]; //第3行
                handler.handleDrop($(this).closest(".container"), file);
                this.value = "";
            });
        },
        handleDrop: function($container, file) {
            var $img = $container.find("img");
            handler.readImgFile(file, $img, $container);
        },
        readImgFile: function(file, $img, $container) {
            EXIF.getData(file, function() {
                var orientation = this.exifdata.Orientation,
                    rotateDeg = 0;
                //如果不是ios拍的照片或者是横拍的，则不用处理，直接读取
                if (typeof orientation === "undefined" || orientation === 1) {
                    //原本的readImgFile，添加一个rotateDeg的参数
                    handler.doReadImgFile(file, $img, $container, rotateDeg);
                }
                //否则用canvas旋转一下
                else {
                    rotateDeg = orientation === 6 ? 90 * Math.PI / 180 :
                        orientation === 8 ? -90 * Math.PI / 180 :
                        orientation === 3 ? 180 * Math.PI / 180 : 0;
                    handler.doReadImgFile(file, $img, $container, rotateDeg);
                }
            });
        }
    }
    </script>
</body>

</html>
